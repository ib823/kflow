# KerjaFlow Build System Configuration (PURIFIED)
# ================================================
# 
# ZERO external services. 100% local execution.
# Every metric is OUR decision. No vendor dictates our quality bar.
#
# Usage: .kbs/kbs.sh reads this file for gate configurations

version: "2.0"
project: "KerjaFlow"
description: "ASEAN Enterprise Workforce Management Platform"
external_services: "ZERO"

# ============================================================================
# QUALITY GATE THRESHOLDS
# ============================================================================

quality_gates:

  # --------------------------------------------------------------------------
  # Code Coverage
  # --------------------------------------------------------------------------
  coverage:
    backend:
      minimum: 70
      target: 85
      fail_under: 70
      critical_files:
        # These files MUST have higher coverage - they handle money/compliance
        - path: "services/statutory_calculator.py"
          minimum: 90
        - path: "services/payroll_engine.py"
          minimum: 85
        - path: "controllers/auth_controller.py"
          minimum: 85
        - path: "models/kf_payslip.py"
          minimum: 80
    
    mobile:
      minimum: 70
      target: 85
      fail_under: 70
      critical_files:
        - path: "core/network/dio_client.dart"
          minimum: 85
        - path: "features/auth/data/auth_repository.dart"
          minimum: 85
        - path: "features/payslip/data/payslip_repository.dart"
          minimum: 80

  # --------------------------------------------------------------------------
  # Linting
  # --------------------------------------------------------------------------
  linting:
    backend:
      python:
        black:
          enabled: true
          check_only: true
          line_length: 120
        flake8:
          enabled: true
          max_line_length: 120
          max_complexity: 10
          ignore:
            - "E501"  # Line too long (handled by black)
            - "W503"  # Line break before binary operator
          exclude:
            - "__pycache__"
            - "migrations"
            - ".git"
            - "*.pyc"
        isort:
          enabled: true
          check_only: true
          profile: "black"
    
    mobile:
      dart:
        flutter_analyze:
          enabled: true
          fatal_infos: true
          fatal_warnings: true

  # --------------------------------------------------------------------------
  # Security Scanning (ALL LOCAL)
  # --------------------------------------------------------------------------
  security:
    bandit:
      enabled: true
      runs_locally: true
      severity: "medium"
      confidence: "medium"
      max_high: 0
      max_medium: 5
      exclude:
        - "tests/"
        - "*_test.py"
    
    safety:
      enabled: true
      runs_locally: true
      max_vulnerabilities: 0
    
    pip_audit:
      enabled: true
      runs_locally: true
      strict: false
    
    secrets:
      enabled: true
      runs_locally: true
      method: "grep"  # Local grep, no external service
      patterns:
        - "password\\s*=\\s*['\"][^'\"]+['\"]"
        - "api_key\\s*=\\s*['\"][^'\"]+['\"]"
        - "secret\\s*=\\s*['\"][^'\"]+['\"]"
        - "AKIA[0-9A-Z]{16}"
        - "-----BEGIN.*PRIVATE KEY-----"
      exclude_paths:
        - "*.example"
        - "*_test.*"
        - "tests/"
        - "docs/"

  # --------------------------------------------------------------------------
  # Build Constraints
  # --------------------------------------------------------------------------
  build:
    mobile:
      apk:
        max_size_mb: 50
        min_sdk: 21
        target_sdk: 34
    
    backend:
      docker:
        build_locally: true
        max_size_mb: 500
        no_root: true

  # --------------------------------------------------------------------------
  # Internationalization
  # --------------------------------------------------------------------------
  i18n:
    baseline_locale: "en"
    baseline_key_count: 197
    
    required_locales:
      - code: "en"
        name: "English"
        minimum_coverage: 100
      - code: "ms"
        name: "Bahasa Malaysia"
        minimum_coverage: 100
      - code: "id"
        name: "Bahasa Indonesia"
        minimum_coverage: 100
      - code: "th"
        name: "Thai"
        minimum_coverage: 100
      - code: "vi"
        name: "Vietnamese"
        minimum_coverage: 100
      - code: "tl"
        name: "Filipino/Tagalog"
        minimum_coverage: 100
      - code: "zh"
        name: "Chinese Simplified"
        minimum_coverage: 100
      - code: "ta"
        name: "Tamil"
        minimum_coverage: 100
      - code: "bn"
        name: "Bengali"
        minimum_coverage: 100
      - code: "ne"
        name: "Nepali"
        minimum_coverage: 100
      - code: "km"
        name: "Khmer"
        minimum_coverage: 100
      - code: "my"
        name: "Myanmar Unicode"
        minimum_coverage: 100

  # --------------------------------------------------------------------------
  # Performance
  # --------------------------------------------------------------------------
  performance:
    api:
      p50_ms: 200
      p95_ms: 500
      p99_ms: 1000
    
    mobile:
      startup_cold_ms: 3000
      startup_warm_ms: 1000

# ============================================================================
# COMPLIANCE REQUIREMENTS
# ============================================================================

compliance:
  
  required_patterns:
    backend:
      - pattern: "Decimal"
        description: "All money calculations must use Decimal"
        files:
          - "statutory_calculator.py"
          - "payroll_engine.py"
          - "kf_payslip.py"
      
      - pattern: "country_code"
        description: "Employee queries must include country_code"
        files:
          - "*_controller.py"
    
    mobile:
      - pattern: "FlutterSecureStorage"
        description: "Sensitive data must use secure storage"
        files:
          - "secure_storage.dart"
          - "auth_repository.dart"
  
  forbidden_patterns:
    backend:
      - pattern: "float\\s*\\("
        description: "Never use float for money - use Decimal"
        exclude:
          - "*_test.py"
      
      - pattern: 'algorithm.*"HS256"'
        description: "Never use HS256 - use RS256"
        exclude: []
      
      - pattern: "date\\.today\\(\\)"
        description: "Use payslip_date for rate lookup, not current date"
        exclude:
          - "*_test.py"
    
    mobile:
      - pattern: "http://"
        description: "All URLs must be HTTPS"
        exclude:
          - "*localhost*"
          - "*_test.dart"

# ============================================================================
# PATHS
# ============================================================================

paths:
  backend:
    root: "backend"
    source: "backend/odoo/addons/kerjaflow"
    tests: "backend/odoo/addons/kerjaflow/tests"
    requirements: "backend/requirements.txt"
  
  mobile:
    root: "mobile"
    source: "mobile/lib"
    tests: "mobile/test"
    l10n: "mobile/lib/l10n"
    pubspec: "mobile/pubspec.yaml"
  
  reports:
    root: ".kbs/reports"
    coverage: ".kbs/reports/coverage"
    security: ".kbs/reports/security"
    tests: ".kbs/reports/tests"
  
  artifacts:
    root: ".kbs/artifacts"
  
  logs:
    root: ".kbs/logs"

# ============================================================================
# NOTIFICATIONS (LOCAL ONLY)
# ============================================================================

notifications:
  # File logging - always enabled, 100% local
  file:
    enabled: true
    path: ".kbs/logs/"
  
  # Console output - always enabled, 100% local
  console:
    enabled: true
    colors: true
  
  # Local email via sendmail (optional, NO external SMTP)
  local_email:
    enabled: false
    method: "sendmail"  # Local only, no external SMTP
    recipients: []

# ============================================================================
# EXPLICITLY DISABLED EXTERNAL SERVICES
# ============================================================================

disabled_services:
  # CI/CD Services - DISABLED
  github_actions: "DISABLED - Use KBS"
  circleci: "DISABLED - Use KBS"
  travis: "DISABLED - Use KBS"
  jenkins_cloud: "DISABLED - Use KBS"
  
  # Notification Services - DISABLED
  slack: "DISABLED - No external webhooks"
  discord: "DISABLED - No external webhooks"
  teams: "DISABLED - No external webhooks"
  pagerduty: "DISABLED - No external services"
  opsgenie: "DISABLED - No external services"
  
  # Monitoring Services - DISABLED
  datadog: "DISABLED - Use local scripts"
  newrelic: "DISABLED - Use local scripts"
  splunk: "DISABLED - Use local scripts"
  
  # Security Services - DISABLED
  snyk: "DISABLED - Use bandit/safety locally"
  sonarcloud: "DISABLED - Use flake8/bandit locally"
  codecov: "DISABLED - Use pytest-cov locally"
  
  # All Webhooks - DISABLED
  webhooks: "DISABLED - No external HTTP calls"
  
  # All Cloud Services - DISABLED
  aws: "DISABLED - No cloud dependencies"
  gcp: "DISABLED - No cloud dependencies"
  azure: "DISABLED - No cloud dependencies"

# ============================================================================
# ENVIRONMENT
# ============================================================================

environment:
  python:
    version: "3.10"
    packages:
      # All run locally after pip install
      - "black"
      - "flake8"
      - "isort"
      - "pytest"
      - "pytest-cov"
      - "bandit"
      - "safety"
      - "pip-audit"
  
  flutter:
    channel: "stable"
    version: ">=3.19.0"

# ============================================================================
# META
# ============================================================================

meta:
  created: "2026-01-09"
  version: "2.0-PURIFIED"
  author: "KerjaFlow Team"
  philosophy: "If we can't own it, we don't use it"
  external_dependencies: 0
  paid_services: 0
  external_api_calls: 0
  webhooks: 0
  cloud_services: 0
