name: Dependency Audit

on:
  schedule:
    # Run every Sunday at 00:00 UTC
    - cron: "0 0 * * 0"
  workflow_dispatch:
    # Allow manual trigger

env:
  PYTHON_VERSION: "3.11"
  FLUTTER_VERSION: "3.19.0"

jobs:
  # ===========================================
  # Python Dependencies Audit
  # ===========================================
  audit-python:
    name: Audit Python Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install audit tools
        run: |
          pip install safety pip-audit

      - name: Run Safety check
        id: safety
        continue-on-error: true
        run: |
          echo "## Python Dependency Vulnerabilities (Safety)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          safety check -r backend/requirements.txt --output json > safety-report.json || true
          if [ -s safety-report.json ]; then
            echo "### Vulnerabilities Found:" >> $GITHUB_STEP_SUMMARY
            cat safety-report.json | jq -r '.vulnerabilities[] | "- **\(.package_name)** (\(.vulnerable_versions)): \(.vulnerability_id) - \(.advisory)"' >> $GITHUB_STEP_SUMMARY || echo "No structured output" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Run pip-audit
        id: pip-audit
        continue-on-error: true
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Python Dependency Vulnerabilities (pip-audit)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          pip-audit -r backend/requirements.txt --format json > pip-audit-report.json || true
          if [ -s pip-audit-report.json ] && [ "$(cat pip-audit-report.json | jq 'length')" -gt 0 ]; then
            echo "### Vulnerabilities Found:" >> $GITHUB_STEP_SUMMARY
            cat pip-audit-report.json | jq -r '.[] | "- **\(.name)** (\(.version)): \(.vulns[].id // "N/A")"' >> $GITHUB_STEP_SUMMARY || echo "No structured output" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: python-audit-reports
          path: |
            safety-report.json
            pip-audit-report.json
          retention-days: 30

  # ===========================================
  # Flutter/Dart Dependencies Audit
  # ===========================================
  audit-flutter:
    name: Audit Flutter Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get dependencies
        working-directory: mobile
        run: flutter pub get

      - name: Run Flutter/Dart outdated check
        working-directory: mobile
        run: |
          echo "## Flutter Dependency Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          flutter pub outdated >> $GITHUB_STEP_SUMMARY 2>&1 || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Check for known vulnerabilities in pubspec
        working-directory: mobile
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deprecated Packages Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          # Check for deprecated packages (this is a simple check)
          if grep -q "deprecated" pubspec.lock 2>/dev/null; then
            echo "⚠️ Deprecated packages found in pubspec.lock" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ No deprecated packages found" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================
  # Create Issue if Vulnerabilities Found
  # ===========================================
  create-issue:
    name: Create Issue for Findings
    runs-on: ubuntu-latest
    needs: [audit-python, audit-flutter]
    if: failure()
    steps:
      - uses: actions/checkout@v4

      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const title = `[Security] Dependency Audit Findings - ${date}`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,dependencies'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Dependency Audit Findings')
            );

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## Weekly Audit Update - ${date}\n\nNew vulnerabilities may have been found. Please review the latest workflow run.`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: `## Dependency Audit Alert\n\nThe weekly dependency audit found potential vulnerabilities.\n\n### Action Required\n1. Review the workflow run details\n2. Update affected dependencies\n3. Re-run the audit to verify fixes\n\n### Resources\n- [Workflow Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n- [Backend Requirements](backend/requirements.txt)\n- [Mobile pubspec.yaml](mobile/pubspec.yaml)`,
                labels: ['security', 'dependencies', 'automated']
              });
            }
